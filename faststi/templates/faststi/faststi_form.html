{% extends "base.html" %}
{% load i18n %}
{% load faststi %}

{% block title %}
    Fast agent-based model of sexually transmitted infections {{block.super}}
{% endblock %}

{% block styles %}
    {{block.super}}
    <style>
     {% include "faststi/faststi.css" %}
    </style>
{% endblock %}

{% block content %}

    <ul id="messages">
        {% if messages %}
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>
                    {{ message }}
                </li>
            {% endfor %}
        {% endif %}
    </ul>

    <h1>FastSTI: Fast agent-based simulation of epidemics</h1>
    <p class="intro">
        This is only a demonstration. We've had to limit what you can do because
        we don't want to break the Internet (or at least our host's server). To
        explore the full potential of FastSTI you'll want to run it on your own
        computer (or a high-performance one that you have access to). The
        <a href="https://faststi.readthedocs.io/en/latest/">documentation</a>
        explains how.
    </p>

    <form id="sim-parameters"
          enctype="multipart/form-data"
          action="{% url 'faststi:faststi_form' %}"
          method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}
        {% for field in form|starts_with:"a_" %}
            <div class="fieldWrapper">
                {{ field.errors }}
                {{ field.label_tag }}
                {{ field }}
            </div>
        {% endfor %}
        <fieldset id="advanced">
            <legend>Advanced parameters</legend>
            <p class="tab-buttons">
                <button type="button"
                        onclick="openCloseTab(this, 'initial-infections')"
                        class="tab-selector">Initial
                </button><button
                             type="button"
                             onclick="openCloseTab(this, 'infectiousness')"
                             class="tab-selector">Infect
                </button><button type="button"
                                 onclick="openCloseTab(this, 'mortality')"
                                 class="tab-selector">Mortality
                </button><button type="button"
                                 onclick="openCloseTab(this, 'misc')"
                                 class="tab-selector">Misc</button>
            </p>

            <div id="initial-infections" class="tabbed">
                <div class="fieldWrapper source-selector"
                     onclick="switchFormFile(this)">
                    {{ form.e0_initial_infections_data_source.errors }}
                    {{ form.e0_initial_infections_data_source.label_tag }}
                    {{ form.e0_initial_infections_data_source }}
                </div>
                <div class="form-parms">
                    {% for field in form|starts_with:"e1_" %}
                        <div class="fieldWrapper">
                            {{ field.errors }}
                            {{ field.label_tag }}
                            {{ field }}
                        </div>
                    {% endfor %}
                </div>
                <div class="fieldWrapper file-parms">
                    {{ form.e2_initial_infections_file.errors }}
                    {{ form.e2_initial_infections_file.label_tag }}
                    {{ form.e2_initial_infections_file }}
                </div>
            </div>

            <div id="infectiousness" class="tabbed">
                <div class="fieldWrapper source-selector"
                     onclick="switchFormFile(this)">
                    {{ form.k0_infectiousness_data_source.errors }}
                    {{ form.k0_infectiousness_data_source.label_tag }}
                    {{ form.k0_infectiousness_data_source }}
                </div>
                <div class="form-parms">
                    {% for field in form|starts_with:"k1_" %}
                        <div class="fieldWrapper">
                            {{ field.errors }}
                            {{ field.label_tag }}
                            {{ field }}
                        </div>
                    {% endfor %}
                </div>
                <div class="fieldWrapper file-parms">
                    {{ form.k2_infectiousness_file.errors }}
                    {{ form.k2_infectiousness_file.label_tag }}
                    {{ form.k2_infectiousness_file }}
                </div>
            </div>

            <div id="mortality" class="tabbed">
                <div class="fieldWrapper source-selector"
                     onclick="switchFormFile(this)">
                    {{ form.h0_mortality_data_source.errors }}
                    {{ form.h0_mortality_data_source.label_tag }}
                    {{ form.h0_mortality_data_source }}
                </div>
                <div class="form-parms">
                    {% for field in form|starts_with:"h1_" %}
                        <div class="fieldWrapper">
                            {{ field.errors }}
                            {{ field.label_tag }}
                            {{ field }}
                        </div>
                    {% endfor %}
                </div>
                <div class="fieldWrapper file-parms">
                    {{ form.h2_mortality_file.errors }}
                    {{ form.h2_mortality_file.label_tag }}
                    {{ form.h2_mortality_file }}
                </div>
            </div>

            <div id="misc" class="tabbed">
                {% for field in form|starts_with:"c_" %}
                    <div class="fieldWrapper">
                        {{ field.errors }}
                        {{ field.label_tag }}
                        {{ field }}
                    </div>
                {% endfor %}
            </div>

        </fieldset>

        <input id="simulate-button" type="submit" value="Simulate">
    </form>


    <div id="charts">
        <canvas id="chart-prevalence">
        </canvas>
        <canvas id="chart-population">
        </canvas>
    </div>

    <h2>Output</h2>

    <ol id="output">

    </ol>

    {% if config_files %}
        <div id="filenames">
            <p>Configuration file:
                <span id="config-filename">
                    <a href="{% url "faststi:faststi_config" config_filename %}"
                       target="_blank">
                        {{config_filename}}
                    </a>
                </span>
            </p>
            <p>Initial infection dataset:
                <span id="initial-infection-filename">
                    <a href="{% url "faststi:faststi_data" initial_infection_filename %}"
                       target="_blank">
                        {{initial_infection_filename}}
                    </a>
                </span>
            </p>
            <p>Mortality dataset:
                <span id="mortality-filename">
                    <a href="{% url "faststi:faststi_data" mortality_filename %}"
                       target="_blank">
                        {{mortality_filename}}
                    </a>
                </span>
            </p>
            <p>Infectiousness dataset:
                <span id="infect-filename">
                    <a href="{% url "faststi:faststi_data" infectiousness_filename %}"
                       target="_blank">
                        {{infectiousness_filename}}
                    </a>
                </span>
            </p>

            <p>Output file:
                <span id="output-filename">
                    <a href="{% url "faststi:faststi_output" output_filename %}"
                       target="_blank">
                        {{output_filename}}
                    </a>
                </span>
            </p>
        </div>
    {% endif %}

    {{ status }}

    <script>
     {% include 'faststi/Chart.bundle.min.js' %}
    </script>

    <script>
     "use strict";
     var timeout = 300;

     var getCookie = function(name) {
         var cookieValue = null;
         if (document.cookie && document.cookie !== '') {
             var cookies = document.cookie.split(';');
             for (var i = 0; i < cookies.length; i++) {
                 var cookie = cookies[i].trim();
                 if (cookie.substring(0, name.length + 1) === (name + '=')) {
                     cookieValue = decodeURIComponent(cookie.substring(
                         name.length + 1));
                     break;
                 }
             }
         }
         return cookieValue;
     }

     var ctx_prev = document.getElementById('chart-prevalence');
     var chart_prev = new Chart(ctx_prev, {
         type: 'line',
         data: {
             labels: [],
             datasets: [
                 {
                     name: "INFECT_RATE_ALIVE",
                     label: 'Prevalence',
                     data: [],
                     borderColor: 'black',
                     borderWidth: 1,
                     fill: false
                 }
             ]
         },
         options: {
             scales: {
                 yAxes: [{
                     ticks: {
                         beginAtZero: true,
                     }
                 }],
             },

             tooltips: {
                 callbacks: {
                     label: function(tooltipItem, data) {
                         var label = Number(tooltipItem.yLabel).toFixed(2);
                         return label;
                     }
                 }
             },
         }
     });

     var ctx_pop = document.getElementById('chart-population');
     var chart_pop = new Chart(ctx_pop, {
         type: 'line',
         data: {
             labels: [],
             datasets: [
                 {
                     name: "POP_ALIVE",
                     label: 'Alive',
                     data: [],
                     borderColor: 'blue',
                     borderWidth: 1,
                     fill: false
                 },
                 {
                     name: "POP_DEAD",
                     label: 'Dead',
                     data: [],
                     borderColor: 'red',
                     borderWidth: 1,
                     fill: false
                 }
             ]
         },
         options: {
             scales: {
                 yAxes: [{
                     ticks: {
                         beginAtZero: true,
                     }
                 }],
             },

             tooltips: {
                 callbacks: {
                     label: function(tooltipItem, data) {
                         var label = Number(tooltipItem.yLabel);
                         return label;
                     }
                 }
             },
         }
     });


     var setMessage = function(msg, tag) {
         if (msg.length > 0) {
             var ul = document.getElementById("messages");
             ul.innerHTML = "";
             var li = document.createElement("li");
             li.innerHTML = msg;
             li.className += " " + tag;
             ul.appendChild(li);
         }
     }

     var getOutput = function() {
         fetch("{% url 'faststi:faststi_fetch' %}", {
             method: 'GET',
             headers: {
                 "X-CSRFToken": getCookie("csrftoken"),
                 'Content-Type': 'application/json',
             }
         }).then(function(response) {
             return response.json();
         }).then(function(dict) {
             setMessage(dict["msg"], dict["msgstatus"]);
             var ul = document.getElementById("output");
             var saved_date = "";
             for (const line of dict["lines"]) {
                 ul.innerHTML += "<li>" + line + "</li>";
                 var cells = line.split(";");
                 if (cells[3] != "date") {
                     if (saved_date != cells[3]) {
                         saved_date = cells[3];
                         chart_prev.data.labels.push(saved_date);
                         chart_pop.data.labels.push(saved_date);
                     }
                     chart_prev.data.datasets.forEach((dataset) => {
                         if (dataset.name === cells[4]) {
                             dataset.data.push(Number(cells[5]));
                         }
                     });
                     chart_pop.data.datasets.forEach((dataset) => {
                         if (dataset.name === cells[4]) {
                             dataset.data.push(Number(cells[5]));
                         }
                     });
                 }
             }
             chart_prev.update();
             chart_pop.update();

             ul.scrollTop = ul.scrollHeight;
             if (dict["status"] == "idle") {
                 document.getElementById("simulate-button").disabled = false;
                 var body = document.getElementsByTagName("body")[0];
                 body.classList.remove("busy");

             } else {
                 var body = document.getElementsByTagName("body")[0];
                 if (body.classList.contains("busy")) {
                 } else {
                     body.classList.add("busy");
                 }
                 setTimeout(getOutput, timeout);
             }
         });
     }

     // Tabbed parameter values

     var openCloseTab = function(elem, parmId) {
         if (elem.classList.contains("selected")) {
             elem.classList.remove("selected");
             document.getElementById(parmId).style.display = "none";
         } else {
             for (var t of document.getElementsByClassName("tab-selector")) {
                 t.classList.remove("selected");
             }
             elem.classList.add("selected");
             var parms = document.getElementsByClassName("tabbed");
             for (var i = 0; i < parms.length; i++) {
                 parms[i].style.display = "none";
             }
             document.getElementById(parmId).style.display = "block";
         }
     }

     // Radio buttons function

     var switchFormFile = function(elem) {
         var form_parms = elem.parentNode.
                               getElementsByClassName("form-parms")[0];
         var file_parms = elem.parentNode.
                               getElementsByClassName("file-parms")[0];
         var options = elem.getElementsByTagName("INPUT");
         if (options[0].checked) {
             form_parms.style.display = "block";
             file_parms.style.display = "none";
         } else {
             form_parms.style.display = "none";
             file_parms.style.display = "block";
         }
     };

     window.addEventListener("load", function() {
         var csrftoken = getCookie('csrftoken');
         if ("{{request.session.status}}" == "running") {
             document.getElementById("simulate-button").disabled = true;
             if ({{duplicate}} == 0) setTimeout(getOutput, timeout);
         } else {
             document.getElementById("simulate-button").disabled = false;
         }

         var uninfected = document.getElementsByClassName("uninfected");
         for (var e of uninfected) {
             if (getComputedStyle(e, null).display != "none") {
                 var text = document.createTextNode('{% trans "Uninfected" %}');
                 e.parentNode.insertBefore(text, e);
             }
         }
         var treated = document.getElementsByClassName("treated");
         for (var e of treated) {
             var text = document.createTextNode('{% trans "Treated" %}');
             e.parentNode.insertBefore(text, e);
         }
         var primary = document.getElementsByClassName("primary");
         for (var e of primary) {
             var text = document.createTextNode('{% trans "Primary" %}');
             e.parentNode.insertBefore(text, e);
         }
         var chronic = document.getElementsByClassName("chronic");
         for (var e of chronic) {
             var text = document.createTextNode('{% trans "Chronic" %}');
             e.parentNode.insertBefore(text, e);
         }
         var final = document.getElementsByClassName("final");
         for (var e of final) {
             var text = document.createTextNode('{% trans "Final" %}');
             e.parentNode.insertBefore(text, e);
         }

         for (var elem of document.getElementsByClassName("source-selector")) {
             switchFormFile(elem);
         }
     });


    </script>
{% endblock %}
