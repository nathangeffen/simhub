{% extends "base.html" %}
{% load i18n %}
{% load faststi %}

{% block title %}
    Fast agent-based model of sexually transmitted infections {{block.super}}
{% endblock %}

{% block styles %}
    {{block.super}}
    <style>
     {% include "faststi/faststi.css" %}
    </style>
{% endblock %}

{% block content %}

    <ul id="messages">
        {% if messages %}
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>
                    {{ message }}
                </li>
            {% endfor %}
        {% endif %}
    </ul>

    <form id="sim-parameters"
          enctype="multipart/form-data"
          action="{% url 'faststi:faststi_form' %}"
          method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}
        {% for field in form|starts_with:"a_" %}
            <div class="fieldWrapper">
                {{ field.errors }}
                {{ field.label_tag }}
                {{ field }}
            </div>
        {% endfor %}
        {% for field in form|starts_with:"c_" %}
            <div class="fieldWrapper">
                {{ field.errors }}
                {{ field.label_tag }}
                {{ field }}
            </div>
        {% endfor %}


        <div id="initial-infections" class="collapsible">
            <p class="collapsible-description">
                <span class="collapsible-description-plus">+</span>
                Initial infections
            </p>
            <div class="content">
                <div class="fieldWrapper source-selector">
                    {{ form.e0_initial_infections_data_source.errors }}
                    {{ form.e0_initial_infections_data_source.label_tag }}
                    {{ form.e0_initial_infections_data_source }}
                </div>
                <div class="form-parms">
                    {% for field in form|starts_with:"e1_" %}
                        <div class="fieldWrapper">
                            {{ field.errors }}
                            {{ field.label_tag }}
                            {{ field }}
                        </div>
                    {% endfor %}
                </div>
                <div class="fieldWrapper file-parms">
                    {{ form.e2_initial_infections_file.errors }}
                    {{ form.e2_initial_infections_file.label_tag }}
                    {{ form.e2_initial_infections_file }}
                </div>
            </div>
        </div>

        <div id="mortality" class="collapsible">
            <p class="collapsible-description">
                <span class="collapsible-description-plus">+</span>
                Mortality
            </p>
            <div  class="content">
                <div class="fieldWrapper source-selector">
                    {{ form.h0_mortality_data_source.errors }}
                    {{ form.h0_mortality_data_source.label_tag }}
                    {{ form.h0_mortality_data_source }}
                </div>
                <div class="form-parms">
                    {% for field in form|starts_with:"h1_" %}
                        <div class="fieldWrapper">
                            {{ field.errors }}
                            {{ field.label_tag }}
                            {{ field }}
                        </div>
                    {% endfor %}
                </div>
                <div class="fieldWrapper file-parms">
                    {{ form.h2_mortality_file.errors }}
                    {{ form.h2_mortality_file.label_tag }}
                    {{ form.h2_mortality_file }}
                </div>
            </div>
        </div>


        <input id="simulate-button" type="submit" value="Simulate">
    </form>

    <div id="charts">
        <canvas id="chart-prevalence">
        </canvas>
        <canvas id="chart-population">
        </canvas>
    </div>


    <ol id="output">
        <p>Configuration file:
            <span id="config-filename">
                <a href="{% url "faststi:faststi_config" config_filename %}">
                    {{config_filename}}
                </a>
            </span>
        </p>
        <p>Initial infection dataset:
            <span id="initial-infection-filename">
                <a href="{% url "faststi:faststi_data" initial_infection_filename %}">
                    {{initial_infection_filename}}
                </a>
            </span>
        </p>
        <p>Mortality dataset:
            <span id="mortality-filename">
                <a href="{% url "faststi:faststi_data" mortality_filename %}">
                    {{mortality_filename}}
                </a>
            </span>
        </p>

        <p>Output file:
            <span id="output-filename">
                <a href="{% url "faststi:faststi_output" output_filename %}">
                    {{output_filename}}
                </a>
            </span>
        </p>
        <h2>Simulation output</h2>
    </ol>

    {{ status }}

    <script>
     {% include 'faststi/Chart.bundle.min.js' %}
    </script>

    <script>
     "use strict";
     var timeout = 300;

     var getCookie = function(name) {
         var cookieValue = null;
         if (document.cookie && document.cookie !== '') {
             var cookies = document.cookie.split(';');
             for (var i = 0; i < cookies.length; i++) {
                 var cookie = cookies[i].trim();
                 if (cookie.substring(0, name.length + 1) === (name + '=')) {
                     cookieValue = decodeURIComponent(cookie.substring(
                         name.length + 1));
                     break;
                 }
             }
         }
         return cookieValue;
     }

     var ctx_prev = document.getElementById('chart-prevalence');
     var chart_prev = new Chart(ctx_prev, {
         type: 'line',
         data: {
             labels: [],
             datasets: [
                 {
                     name: "INFECT_RATE_ALIVE",
                     label: 'Prevalence',
                     data: [],
                     borderColor: 'black',
                     borderWidth: 1,
                     fill: false
                 }
             ]
         },
         options: {
             scales: {
                 yAxes: [{
                     ticks: {
                         beginAtZero: true,
                     }
                 }],
             },

             tooltips: {
                 callbacks: {
                     label: function(tooltipItem, data) {
                         var label = Number(tooltipItem.yLabel).toFixed(2);
                         return label;
                     }
                 }
             },
         }
     });

     var ctx_pop = document.getElementById('chart-population');
     var chart_pop = new Chart(ctx_pop, {
         type: 'line',
         data: {
             labels: [],
             datasets: [
                 {
                     name: "POP_ALIVE",
                     label: 'Alive',
                     data: [],
                     borderColor: 'blue',
                     borderWidth: 1,
                     fill: false
                 },
                 {
                     name: "POP_DEAD",
                     label: 'Dead',
                     data: [],
                     borderColor: 'red',
                     borderWidth: 1,
                     fill: false
                 }
             ]
         },
         options: {
             scales: {
                 yAxes: [{
                     ticks: {
                         beginAtZero: true,
                     }
                 }],
             },

             tooltips: {
                 callbacks: {
                     label: function(tooltipItem, data) {
                         var label = Number(tooltipItem.yLabel);
                         return label;
                     }
                 }
             },
         }
     });


     var setMessage = function(msg, tag) {
         if (msg.length > 0) {
             var ul = document.getElementById("messages");
             ul.innerHTML = "";
             var li = document.createElement("li");
             li.innerHTML = msg;
             li.className += " " + tag;
             ul.appendChild(li);
         }
     }

     var getOutput = function() {
         fetch("{% url 'faststi:faststi_fetch' %}", {
             method: 'GET',
             headers: {
                 "X-CSRFToken": getCookie("csrftoken"),
                 'Content-Type': 'application/json',
             }
         }).then(function(response) {
             return response.json();
         }).then(function(dict) {
             setMessage(dict["msg"], dict["msgstatus"]);
             var ul = document.getElementById("output");
             var saved_date = "";
             for (const line of dict["lines"]) {
                 ul.innerHTML += "<li>" + line + "</li>";
                 var cells = line.split(";");
                 if (saved_date != cells[3]) {
                     saved_date = cells[3];
                     console.log(saved_date);
                     chart_prev.data.labels.push(saved_date);
                     chart_pop.data.labels.push(saved_date);
                 }
                 chart_prev.data.datasets.forEach((dataset) => {
                     if (dataset.name === cells[4]) {
                         dataset.data.push(Number(cells[5]));
                         console.log(cells[5]);
                     }
                 });
                 chart_pop.data.datasets.forEach((dataset) => {
                     if (dataset.name === cells[4]) {
                         dataset.data.push(Number(cells[5]));
                     }
                 });
             }
             chart_prev.update();
             chart_pop.update();

             ul.scrollTop = ul.scrollHeight;
             if (dict["status"] == "idle") {
                 document.getElementById("simulate-button").disabled = false;
                 var body = document.getElementsByTagName("body")[0];
                 body.classList.remove("busy");

             } else {
                 var body = document.getElementsByTagName("body")[0];
                 if (body.classList.contains("busy")) {
                 } else {
                     body.classList.add("busy");
                 }
                 setTimeout(getOutput, timeout);
             }
         });
     }

     window.addEventListener("load", function() {
         var csrftoken = getCookie('csrftoken');
         if ("{{request.session.status}}" == "running") {
             document.getElementById("simulate-button").disabled = true;
             if ({{duplicate}} == 0) setTimeout(getOutput, timeout);
         } else {
             document.getElementById("simulate-button").disabled = false;
         }

         // Add events to collapsible groups of form elements
         var coll = document.getElementsByClassName("collapsible");
         for (var i = 0; i < coll.length; i++) {
             var button = coll[i].getElementsByClassName(
                 "collapsible-description")[0];
             button.addEventListener("click", function() {
                 var content = this.parentElement.
                                    getElementsByClassName("content")[0];
                 var plus = this.parentElement.getElementsByClassName(
                     "collapsible-description-plus")[0];
                 console.log(content.style.maxHeight);
                 if (content.style.maxHeight != "") {
                     content.style.maxHeight = null;
                     content.style.padding = "0";
                     plus.textContent = "+";
                 } else {
                     content.style.maxHeight = content.scrollHeight + "px";
                     content.style.padding = "12px";
                     plus.textContent = "-";

                 }
             });
         }

         var uninfected = document.getElementsByClassName("uninfected");
         for (var e of uninfected) {
             if (getComputedStyle(e, null).display != "none") {
                 var text = document.createTextNode('{% trans "Uninfected" %}');
                 e.parentNode.insertBefore(text, e);
             }
         }
         var treated = document.getElementsByClassName("treated");
         for (var e of treated) {
             var text = document.createTextNode('{% trans "Treated" %}');
             e.parentNode.insertBefore(text, e);
         }
         var primary = document.getElementsByClassName("primary");
         for (var e of primary) {
             var text = document.createTextNode('{% trans "Primary" %}');
             e.parentNode.insertBefore(text, e);
         }
         var chronic = document.getElementsByClassName("chronic");
         for (var e of chronic) {
             var text = document.createTextNode('{% trans "Chronic" %}');
             e.parentNode.insertBefore(text, e);
         }
         var final = document.getElementsByClassName("final");
         for (var e of final) {
             var text = document.createTextNode('{% trans "Final" %}');
             e.parentNode.insertBefore(text, e);
         }

         // Add events for radio buttons choosing between file and form
         var rb_div = document.getElementsByClassName("source-selector");
         for (var i = 0; i < rb_div.length; i++) {
             var rb = rb_div[i].getElementsByTagName('input')[0];
             var form_parms = rb_div[i].parentNode.
                                        getElementsByClassName('form-parms')[0];
             var file_parms = rb_div[i].parentNode.
                                        getElementsByClassName('file-parms')[0];
             if (rb.checked) {
                 form_parms.style.display = "block";
                 file_parms.style.display = "none";
             } else {
                 form_parms.style.display = "none";
                 file_parms.style.display = "block";
             }
             rb.addEventListener("change", function() {
                 form_parms.style.display = "block";
                 file_parms.style.display = "none";
             });
             rb = rb_div[i].getElementsByTagName('input')[1];
             form_parms = rb_div[i].parentNode.
                                    getElementsByClassName('form-parms')[0];
             file_parms = rb_div[i].parentNode.
                                    getElementsByClassName('file-parms')[0];
             rb.addEventListener("change", function() {
                 form_parms.style.display = "none";
                 file_parms.style.display = "block";
             });
         }
     });


    </script>
{% endblock %}
